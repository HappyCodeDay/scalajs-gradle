group 'scalajs'
version '1.0-SNAPSHOT'

import org.apache.tools.ant.taskdefs.condition.Os

apply plugin: 'java'

sourceCompatibility = 1.8

repositories {
    mavenCentral()
}

dependencies {
    compile 'org.codehaus.groovy:groovy-all:2.3.11'
    testCompile group: 'junit', name: 'junit', version: '4.11'
    compile group: 'org.scala-js', name: 'scalajs-cli_2.11', version: '0.6.7'
    compile group: 'org.scala-js', name: 'scalajs-compiler_2.11.7', version: '0.6.7'
    compile group: 'org.scala-js', name: 'scalajs-library_2.11', version: '0.6.7'
}

buildscript {
    repositories {
        mavenCentral()
    }
    dependencies {

    }
}
def sjsirPath = 'sjsir/'
def jsPath = 'js/'
def sjslibPath = configurations.runtime.filter{it.name.equals("scalajs-library_2.11-0.6.7.jar")}.first().absolutePath
def sjscompPath = configurations.runtime.filter{it.name.equals("scalajs-compiler_2.11.7-0.6.7.jar")}.first().absolutePath
def cmdExe = Os.isFamily(Os.FAMILY_WINDOWS) ? 'cmd' : 'bash'

task createDirs {
    def sjsirDir=file(sjsirPath)
    if (!sjsirDir.exists()){
        if (!sjsirDir.mkdir())
        {
            logger.error('Couldn\'t create "'+sjsirPath+'" directory')
        }
    }
    def jsDir = file(jsPath)
    if (!jsDir.exists()){
        if (!jsDir.mkdir()){
            logger.error('Couldn\'t create "'+jsPath+'"directory')
        }
    }
}
task compileSJSIR (type: Exec, dependsOn: 'createDirs') {
    executable = cmdExe
    args = ['/C','scalac','-classpath',sjslibPath,'-Xplugin',sjscompPath,'-d',sjsirPath,'src/test.scala']
}
task compileSJSIR2 (type: Exec) {
    executable = "lib/scalajs-cli_2.11-0.6.7/scalajsc.bat"
    args = ['-d','sjsir','src/test.scala']
}
task compileJS (type: Exec, dependsOn: 'compileSJSIR') {
    def jsld = 'org.scalajs.cli.Scalajsld'
    def output = jsPath+project.name+'.js'
    executable = cmdExe
    args = ['/C','scala', '-classpath', 'lib/scalajs-cli-assembly_2.11-0.6.7.jar', jsld, '--stdlib', sjslibPath,sjsirPath,'-o',output]
}
task compileJS2 (type: Exec) {
    executable = "lib/scalajs-cli_2.11-0.6.7/scalajsld.bat"
    args = ['sjsir/','-d','generatedJS/']
}
task printDep << {
    configurations.runtime.each{ println it}
}

compileJS.mustRunAfter compileSJSIR